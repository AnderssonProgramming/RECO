# Script de Monitoreo de Red - Windows Server con GUI
# Lab 07 - Redes de Computadores
# Requiere PowerShell 5.1 o superior
# Version SIN EMOJIS para compatibilidad total

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# Funcion para crear el formulario principal
function Show-MainForm {
    $form = New-Object System.Windows.Forms.Form
    $form.Text = "Monitor de Red - Windows Server | Lab 07"
    $form.Size = New-Object System.Drawing.Size(900, 650)
    $form.StartPosition = "CenterScreen"
    $form.BackColor = [System.Drawing.Color]::White
    $form.FormBorderStyle = 'FixedDialog'
    $form.MaximizeBox = $false

    # Banner
    $labelBanner = New-Object System.Windows.Forms.Label
    $labelBanner.Location = New-Object System.Drawing.Point(20, 20)
    $labelBanner.Size = New-Object System.Drawing.Size(840, 60)
    $labelBanner.Font = New-Object System.Drawing.Font("Segoe UI", 16, [System.Drawing.FontStyle]::Bold)
    $labelBanner.ForeColor = [System.Drawing.Color]::DarkBlue
    $labelBanner.Text = "MONITOR DE RED - WINDOWS SERVER`nLab 07 - Infraestructura y Capa de Red"
    $labelBanner.TextAlign = 'MiddleCenter'
    $form.Controls.Add($labelBanner)

    # Panel de botones
    $panelButtons = New-Object System.Windows.Forms.Panel
    $panelButtons.Location = New-Object System.Drawing.Point(20, 100)
    $panelButtons.Size = New-Object System.Drawing.Size(250, 500)
    $panelButtons.BorderStyle = 'FixedSingle'
    $form.Controls.Add($panelButtons)

    # TextBox para salida
    $textOutput = New-Object System.Windows.Forms.RichTextBox
    $textOutput.Location = New-Object System.Drawing.Point(290, 100)
    $textOutput.Size = New-Object System.Drawing.Size(570, 500)
    $textOutput.Font = New-Object System.Drawing.Font("Consolas", 9)
    $textOutput.BackColor = [System.Drawing.Color]::Black
    $textOutput.ForeColor = [System.Drawing.Color]::Lime
    $textOutput.ReadOnly = $true
    $textOutput.Multiline = $true
    $textOutput.ScrollBars = "Vertical"
    $form.Controls.Add($textOutput)

    # Funcion para agregar texto con color
    function Add-ColoredText {
        param($text, $color = "Lime")
        $textOutput.SelectionStart = $textOutput.TextLength
        $textOutput.SelectionLength = 0
        $textOutput.SelectionColor = [System.Drawing.Color]::FromName($color)
        $textOutput.AppendText("$text`r`n")
        $textOutput.SelectionColor = $textOutput.ForeColor
        $textOutput.ScrollToCaret()
    }

    # Funcion para limpiar salida
    function Clear-Output {
        $textOutput.Clear()
    }

    # Boton 1: Interfaces de Red
    $btnInterfaces = New-Object System.Windows.Forms.Button
    $btnInterfaces.Location = New-Object System.Drawing.Point(10, 20)
    $btnInterfaces.Size = New-Object System.Drawing.Size(220, 50)
    $btnInterfaces.Text = "[1] Ver Interfaces de Red"
    $btnInterfaces.Font = New-Object System.Drawing.Font("Segoe UI", 10)
    $btnInterfaces.Add_Click({
        Clear-Output
        Add-ColoredText "=== INTERFACES DE RED ===`r`n" "Cyan"
        
        Add-ColoredText ">> Adaptadores de Red Activos:" "Yellow"
        $adapters = Get-NetAdapter | Where-Object {$_.Status -eq "Up"}
        foreach ($adapter in $adapters) {
            Add-ColoredText "  Nombre: $($adapter.Name)" "White"
            Add-ColoredText "  Estado: $($adapter.Status)" "Lime"
            Add-ColoredText "  Velocidad: $($adapter.LinkSpeed)" "White"
            Add-ColoredText "  MAC: $($adapter.MacAddress)" "White"
            
            $ipConfig = Get-NetIPAddress -InterfaceIndex $adapter.ifIndex -ErrorAction SilentlyContinue
            foreach ($ip in $ipConfig) {
                if ($ip.AddressFamily -eq "IPv4") {
                    Add-ColoredText "  IPv4: $($ip.IPAddress)/$($ip.PrefixLength)" "Cyan"
                }
            }
            Add-ColoredText "" "White"
        }
        
        Add-ColoredText "`r`n>> Estadisticas de Interfaces:" "Yellow"
        $stats = Get-NetAdapterStatistics
        foreach ($stat in $stats) {
            $rxMB = [math]::Round($stat.ReceivedBytes / 1MB, 2)
            $txMB = [math]::Round($stat.SentBytes / 1MB, 2)
            Add-ColoredText "  $($stat.Name): RX $rxMB MB  TX $txMB MB" "White"
        }
    })
    $panelButtons.Controls.Add($btnInterfaces)

    # Boton 2: Conexiones Activas
    $btnConnections = New-Object System.Windows.Forms.Button
    $btnConnections.Location = New-Object System.Drawing.Point(10, 80)
    $btnConnections.Size = New-Object System.Drawing.Size(220, 50)
    $btnConnections.Text = "[2] Ver Conexiones Activas"
    $btnConnections.Font = New-Object System.Drawing.Font("Segoe UI", 10)
    $btnConnections.Add_Click({
        Clear-Output
        Add-ColoredText "=== CONEXIONES DE RED ACTIVAS ===`r`n" "Cyan"
        
        Add-ColoredText ">> Conexiones TCP Establecidas:" "Yellow"
        $connections = Get-NetTCPConnection -State Established -ErrorAction SilentlyContinue | Select-Object -First 20
        foreach ($conn in $connections) {
            $localAddr = "$($conn.LocalAddress):$($conn.LocalPort)"
            $remoteAddr = "$($conn.RemoteAddress):$($conn.RemotePort)"
            Add-ColoredText "  $localAddr -> $remoteAddr [$($conn.State)]" "White"
        }
        
        Add-ColoredText "`r`n>> Estadisticas por Estado:" "Yellow"
        $allConns = Get-NetTCPConnection -ErrorAction SilentlyContinue
        $states = $allConns | Group-Object -Property State
        foreach ($state in $states) {
            Add-ColoredText "  $($state.Name): $($state.Count) conexiones" "White"
        }
        
        Add-ColoredText "`r`n>> Top 5 IPs Remotas:" "Yellow"
        $topIPs = $allConns | Where-Object {$_.RemoteAddress -ne "0.0.0.0" -and $_.RemoteAddress -ne "::"} |
                  Group-Object -Property RemoteAddress | Sort-Object Count -Descending | Select-Object -First 5
        foreach ($ip in $topIPs) {
            Add-ColoredText "  $($ip.Count) conexiones desde $($ip.Name)" "White"
        }
    })
    $panelButtons.Controls.Add($btnConnections)

    # Boton 3: Tabla de Enrutamiento
    $btnRouting = New-Object System.Windows.Forms.Button
    $btnRouting.Location = New-Object System.Drawing.Point(10, 140)
    $btnRouting.Size = New-Object System.Drawing.Size(220, 50)
    $btnRouting.Text = "[3] Ver Tabla de Enrutamiento"
    $btnRouting.Font = New-Object System.Drawing.Font("Segoe UI", 10)
    $btnRouting.Add_Click({
        Clear-Output
        Add-ColoredText "=== TABLA DE ENRUTAMIENTO ===`r`n" "Cyan"
        
        Add-ColoredText ">> Rutas IPv4:" "Yellow"
        $routes = Get-NetRoute -AddressFamily IPv4 | Select-Object -First 20
        foreach ($route in $routes) {
            $dest = "$($route.DestinationPrefix)"
            $nextHop = $route.NextHop
            $metric = $route.RouteMetric
            $iface = (Get-NetAdapter -InterfaceIndex $route.InterfaceIndex -ErrorAction SilentlyContinue).Name
            Add-ColoredText "  Destino: $dest -> Gateway: $nextHop [Metrica: $metric] via $iface" "White"
        }
        
        Add-ColoredText "`r`n>> Gateway Predeterminado:" "Yellow"
        $defaultGW = Get-NetRoute -DestinationPrefix "0.0.0.0/0" -ErrorAction SilentlyContinue
        if ($defaultGW) {
            Add-ColoredText "  Gateway: $($defaultGW.NextHop)" "Lime"
            Add-ColoredText "  Interfaz: $((Get-NetAdapter -InterfaceIndex $defaultGW.InterfaceIndex).Name)" "White"
        }
    })
    $panelButtons.Controls.Add($btnRouting)

    # Boton 4: Puertos Abiertos
    $btnPorts = New-Object System.Windows.Forms.Button
    $btnPorts.Location = New-Object System.Drawing.Point(10, 200)
    $btnPorts.Size = New-Object System.Drawing.Size(220, 50)
    $btnPorts.Text = "[4] Ver Puertos Abiertos"
    $btnPorts.Font = New-Object System.Drawing.Font("Segoe UI", 10)
    $btnPorts.Add_Click({
        Clear-Output
        Add-ColoredText "=== PUERTOS ABIERTOS Y SERVICIOS ===`r`n" "Cyan"
        
        Add-ColoredText ">> Puertos TCP en ESCUCHA:" "Yellow"
        $tcpListeners = Get-NetTCPConnection -State Listen | Select-Object -First 15
        foreach ($listener in $tcpListeners) {
            $process = Get-Process -Id $listener.OwningProcess -ErrorAction SilentlyContinue
            $processName = if ($process) { $process.ProcessName } else { "N/A" }
            Add-ColoredText "  TCP $($listener.LocalAddress):$($listener.LocalPort) - Proceso: $processName (PID: $($listener.OwningProcess))" "White"
        }
        
        Add-ColoredText "`r`n>> Puertos UDP Activos:" "Yellow"
        $udpListeners = Get-NetUDPEndpoint | Select-Object -First 10
        foreach ($listener in $udpListeners) {
            $process = Get-Process -Id $listener.OwningProcess -ErrorAction SilentlyContinue
            $processName = if ($process) { $process.ProcessName } else { "N/A" }
            Add-ColoredText "  UDP $($listener.LocalAddress):$($listener.LocalPort) - Proceso: $processName (PID: $($listener.OwningProcess))" "White"
        }
        
        Add-ColoredText "`r`n>> Resumen:" "Yellow"
        $tcpCount = (Get-NetTCPConnection -State Listen).Count
        $udpCount = (Get-NetUDPEndpoint).Count
        Add-ColoredText "  Total puertos TCP en escucha: $tcpCount" "White"
        Add-ColoredText "  Total endpoints UDP: $udpCount" "White"
    })
    $panelButtons.Controls.Add($btnPorts)

    # Boton 5: Estadisticas
    $btnStats = New-Object System.Windows.Forms.Button
    $btnStats.Location = New-Object System.Drawing.Point(10, 260)
    $btnStats.Size = New-Object System.Drawing.Size(220, 50)
    $btnStats.Text = "[5] Ver Estadisticas de Trafico"
    $btnStats.Font = New-Object System.Drawing.Font("Segoe UI", 10)
    $btnStats.Add_Click({
        Clear-Output
        Add-ColoredText "=== ESTADISTICAS DE TRAFICO ===`r`n" "Cyan"
        
        Add-ColoredText ">> Estadisticas TCP/IP:" "Yellow"
        $tcpStats = Get-NetTCPConnection | Measure-Object
        Add-ColoredText "  Total conexiones TCP: $($tcpStats.Count)" "White"
        
        $established = (Get-NetTCPConnection -State Established | Measure-Object).Count
        Add-ColoredText "  Conexiones establecidas: $established" "Lime"
        
        Add-ColoredText "`r`n>> Trafico por Adaptador:" "Yellow"
        $adapters = Get-NetAdapterStatistics
        foreach ($adapter in $adapters) {
            $rxMB = [math]::Round($adapter.ReceivedBytes / 1MB, 2)
            $txMB = [math]::Round($adapter.SentBytes / 1MB, 2)
            Add-ColoredText "  $($adapter.Name):" "Cyan"
            Add-ColoredText "    Recibido: $rxMB MB ($($adapter.ReceivedUnicastPackets) paquetes)" "White"
            Add-ColoredText "    Enviado: $txMB MB ($($adapter.SentUnicastPackets) paquetes)" "White"
        }
        
        Add-ColoredText "`r`n>> Estadisticas de Red (netstat):" "Yellow"
        $netstatOutput = netstat -e
        foreach ($line in $netstatOutput) {
            Add-ColoredText "  $line" "White"
        }
    })
    $panelButtons.Controls.Add($btnStats)

    # Boton 6: Verificar Puerto
    $btnCheckPort = New-Object System.Windows.Forms.Button
    $btnCheckPort.Location = New-Object System.Drawing.Point(10, 320)
    $btnCheckPort.Size = New-Object System.Drawing.Size(220, 50)
    $btnCheckPort.Text = "[6] Verificar Puerto"
    $btnCheckPort.Font = New-Object System.Drawing.Font("Segoe UI", 10)
    $btnCheckPort.Add_Click({
        $portInput = [Microsoft.VisualBasic.Interaction]::InputBox("Ingrese el numero de puerto a verificar (1-65535):", "Verificar Puerto", "80")
        
        if ([string]::IsNullOrWhiteSpace($portInput)) {
            [System.Windows.Forms.MessageBox]::Show("Operacion cancelada", "Informacion", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)
            return
        }
        
        $port = 0
        if (-not [int]::TryParse($portInput, [ref]$port) -or $port -lt 1 -or $port -gt 65535) {
            [System.Windows.Forms.MessageBox]::Show("Puerto invalido. Debe ser un numero entre 1 y 65535", "Error", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error)
            return
        }
        
        Clear-Output
        Add-ColoredText "=== VERIFICADOR DE PUERTOS ===`r`n" "Cyan"
        Add-ColoredText ">> Verificando puerto $port...`r`n" "Yellow"
        
        # Verificar TCP
        $tcpResult = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
        if ($tcpResult) {
            Add-ColoredText "[OK] Puerto $port/TCP esta ABIERTO" "Lime"
            foreach ($conn in $tcpResult) {
                Add-ColoredText "  Estado: $($conn.State)" "White"
                Add-ColoredText "  Direccion Local: $($conn.LocalAddress):$($conn.LocalPort)" "White"
                
                $process = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
                if ($process) {
                    Add-ColoredText "  Proceso: $($process.ProcessName) (PID: $($conn.OwningProcess))" "Cyan"
                    Add-ColoredText "  Ruta: $($process.Path)" "White"
                }
            }
        } else {
            Add-ColoredText "[X] Puerto $port/TCP esta CERRADO" "Red"
        }
        
        Add-ColoredText "" "White"
        
        # Verificar UDP
        $udpResult = Get-NetUDPEndpoint -LocalPort $port -ErrorAction SilentlyContinue
        if ($udpResult) {
            Add-ColoredText "[OK] Puerto $port/UDP esta ABIERTO" "Lime"
            foreach ($endpoint in $udpResult) {
                Add-ColoredText "  Direccion Local: $($endpoint.LocalAddress):$($endpoint.LocalPort)" "White"
                
                $process = Get-Process -Id $endpoint.OwningProcess -ErrorAction SilentlyContinue
                if ($process) {
                    Add-ColoredText "  Proceso: $($process.ProcessName) (PID: $($endpoint.OwningProcess))" "Cyan"
                    Add-ColoredText "  Ruta: $($process.Path)" "White"
                }
            }
        } else {
            Add-ColoredText "[i] Puerto $port/UDP no esta en escucha" "Yellow"
        }
        
        # Intentar identificar servicio comun
        Add-ColoredText "`r`n>> Servicios comunes en puerto ${port}:" "Yellow"
        $commonPorts = @{
            20 = "FTP Data"; 21 = "FTP Control"; 22 = "SSH"; 23 = "Telnet"
            25 = "SMTP"; 53 = "DNS"; 80 = "HTTP"; 110 = "POP3"
            143 = "IMAP"; 443 = "HTTPS"; 445 = "SMB"; 3306 = "MySQL"
            3389 = "RDP"; 5432 = "PostgreSQL"; 8080 = "HTTP Alternate"
        }
        
        if ($commonPorts.ContainsKey($port)) {
            Add-ColoredText "  $($commonPorts[$port])" "Cyan"
        } else {
            Add-ColoredText "  No es un puerto de servicio comun conocido" "White"
        }
    })
    $panelButtons.Controls.Add($btnCheckPort)

    # Boton Salir
    $btnExit = New-Object System.Windows.Forms.Button
    $btnExit.Location = New-Object System.Drawing.Point(10, 430)
    $btnExit.Size = New-Object System.Drawing.Size(220, 50)
    $btnExit.Text = "[X] Salir"
    $btnExit.Font = New-Object System.Drawing.Font("Segoe UI", 10, [System.Drawing.FontStyle]::Bold)
    $btnExit.BackColor = [System.Drawing.Color]::LightCoral
    $btnExit.Add_Click({
        $form.Close()
    })
    $panelButtons.Controls.Add($btnExit)

    # Mensaje inicial
    Add-ColoredText "=============================================================" "Cyan"
    Add-ColoredText "  Bienvenido al Monitor de Red - Windows Server" "Cyan"
    Add-ColoredText "  Lab 07 - Infraestructura y Capa de Red" "Cyan"
    Add-ColoredText "=============================================================" "Cyan"
    Add-ColoredText "`r`nSeleccione una opcion del menu lateral para comenzar...`r`n" "Yellow"
    Add-ColoredText "[i] Algunas funciones requieren permisos de administrador" "White"

    # Mostrar el formulario
    [void]$form.ShowDialog()
}

# Cargar ensamblado para InputBox
Add-Type -AssemblyName Microsoft.VisualBasic

# Verificar permisos de administrador
$isAdmin = ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

if (-not $isAdmin) {
    $result = [System.Windows.Forms.MessageBox]::Show(
        "ADVERTENCIA: Este script no se esta ejecutando como Administrador.`n`nAlgunas funciones pueden tener informacion limitada.`n`nDesea continuar de todos modos?",
        "Advertencia de Permisos",
        [System.Windows.Forms.MessageBoxButtons]::YesNo,
        [System.Windows.Forms.MessageBoxIcon]::Warning
    )
    
    if ($result -eq [System.Windows.Forms.DialogResult]::No) {
        exit
    }
}

# Ejecutar el formulario
Show-MainForm